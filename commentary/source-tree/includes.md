# GHC Source Tree Roadmap: includes/


This directory contains C header files that are included in a GHC
distribution.  The headers fall into several categories.

## External APIs


These are header files that define an external API to the RTS that can
be used by client code.  These interfaces are intended to be
relatively stable:

<table><tr><th>[ HsFFI.h](http://darcs.haskell.org/ghc/includes/HsFFI.h)</th>
<td>
The external FFI api, as required by the FFI spec
</td></tr></table>

<table><tr><th>[ RtsAPI.h](http://darcs.haskell.org/ghc/includes/RtsAPI.h)</th>
<td>
The API for calling into the RTS.  Used by the implementation
of `foreign export` calls, but may also be used by external
clients.
</td></tr></table>

<table><tr><th>[ Rts.h](http://darcs.haskell.org/ghc/includes/Rts.h)</th>
<td>
This header file defines everything that is visible
externally to the RTS.  It includes `Stg.h` and everything
in the `rts` subdirectory.
</td></tr></table>

## Derived Constants


The canonical definition of certain structures are in C header files.
For example, the layout of closures and info tables are defined in the
headers [ Closures.h](http://darcs.haskell.org/ghc/includes/rts/storage/Closures.h) and
[ InfoTables.h](http://darcs.haskell.org/ghc/includes/rts/storage/InfoTables.h) respectivesly.  How do we get the information about the
layout of these structures to the parts of the system that are not
written in C, such as the compiler itself, or the C-- code in the RTS?


Our solution is the C program
[ mkDerivedConstants.c](http://darcs.haskell.org/ghc/includes/mkDerivedConstants.c).
It `#includes` the C header files containing the structure
definitions, and emits a new C header file containing only `#define`s
that give the byte offsets of important fields in those structures.
The program generates the following files:

- `DerivedConstants.h`
- `GHCConstants.h`


Take a look at those files in a build tree to see exactly what is
generated.  These new headers can then be `#included` into Haskell
code or C-- code.

## Used when compiling via C


These header files are `#included` into the `.hc` file
generated by GHC when it compiles Haskell code to C.  They are also
`#included` by `Rts.h`, so the definitions from these files are shared
by the RTS code.


These days the amount of stuff included this way is kept to a minimum.
In particular, there are no function prototypes: all calls to C
functions from `.hc` files are given types at the call site.

<table><tr><th>[ Stg.h](http://darcs.haskell.org/ghc/includes/Stg.h)</th>
<td>
The top of the hierarchy is `Stg.h`, which includes everything
required by `.hc` code.  Most files `#included` by `Stg.h` are in the
`stg` subdirectory.
</td></tr></table>

<table><tr><th>[ ghcconfig.h](http://darcs.haskell.org/ghc/includes/ghcconfig.h)</th>
<td>
Configuration info derived by the `configure` script.
</td></tr>
<tr><th>[ MachDeps.h](http://darcs.haskell.org/ghc/includes/MachDeps.h)</th>
<td>
Sizes of various basic types (should be in the `stg` subdirectory,
but left here for backwards-compatibility reasons).
</td></tr>
<tr><th>[ stg/DLL.h](http://darcs.haskell.org/ghc/includes/stg/DLL.h)</th>
<td>
Stuff related to Windows DLLs.
</td></tr>
<tr><th>[ stg/MachRegs.h](http://darcs.haskell.org/ghc/includes/stg/MachRegs.h)</th>
<td>
Global register assignments for this processor.
</td></tr>
<tr><th>[ stg/MiscClosures.h](http://darcs.haskell.org/ghc/includes/stg/MiscClosures.h)</th>
<td>
Declarations for closures & info tables built-in to the RTS
</td></tr>
<tr><th>[ stg/Regs.h](http://darcs.haskell.org/ghc/includes/stg/Regs.h)</th>
<td>
"registers" in the virtual machine.
</td></tr>
<tr><th>[ stg/SMP.h](http://darcs.haskell.org/ghc/includes/stg/SMP.h)</th>
<td>
Atomic memory operations for SMP support
</td></tr>
<tr><th>[ stg/TailCalls.h](http://darcs.haskell.org/ghc/includes/stg/TailCalls.h)</th>
<td>
Tail calls in `.hc` code.
</td></tr>
<tr><th>[ stg/Ticky.h](http://darcs.haskell.org/ghc/includes/stg/Ticky.h)</th>
<td>
Declarations for ticky-ticky counters
</td></tr>
<tr><th>[ stg/Types.h](http://darcs.haskell.org/ghc/includes/stg/Types.h)</th>
<td>
Basic types specific to the virtual machine (eg. `StgWord`).
</td></tr></table>

## The RTS external APIs


The header [ Rts.h](http://darcs.haskell.org/ghc/includes/Rts.h)
includes all the headers below the `rts` subdirectory, which together
define the RTS external API.  Virtually all RTS code `#includes``Rts.h`.


The rts header files are divided into a few directories:

- [ includes/rts](http://darcs.haskell.org/ghc/includes/rts): Most of
  the external RTS APIs, in separate header files per-subsystem

- [ includes/rts/storage](http://darcs.haskell.org/ghc/includes/rts/storage): Definitions of the layout of heap and stack
  objects, info tables, structures that define memory areas managed
  by the GC, and memory management APIs.

- [ includes/rts/prof](http://darcs.haskell.org/ghc/includes/rts/prof):
  Interfaces and definitions for profiling.

## Included into C-- (`.cmm`) code

<table><tr><th>[ Cmm.h](http://darcs.haskell.org/ghc/includes/Cmm.h)</th>
<td>
included into `.cmm` source only; provides useful macros for writing
low-level C-- code for GHC.
</td></tr></table>