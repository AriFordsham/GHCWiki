# Compiler performance


This is where we track various efforts to characterize and improve the performance of the compiler itself. If you are interested in the performance of code generated by GHC, see [Performance/Runtime](performance/runtime).

## Relevant tickets

[ https://ghc.haskell.org/trac/ghc/query?status=!closed&failure=Compile-time+performance+bug](https://ghc.haskell.org/trac/ghc/query?status=!closed&failure=Compile-time+performance+bug)

### Type pile-up


Some programs can produce very deeply nested types of non-linear size. See Scrap your type applications? for a way to improve these bad cases

- [\#9198](https://gitlab.haskell.org//ghc/ghc/issues/9198): large performance regression in type checker speed in 7.8 

  - Types in Core blowing up quadratically (as seen in `-ddump-ds` output)

### Coercion pile-up


One theme that seems to pop up rather often is the production of Core with long strings of coercions, with the size scaling non-linearly with the size of the types in the source program. These may or may not be due to similar root-causes.

- [\#8095](https://gitlab.haskell.org//ghc/ghc/issues/8095): TypeFamilies painfully slow

  - Here a recursive type family instance leads to quadratic blow-up of coercions

  This ticket has a discussion about a way to snip off coercions when not using `-dcore-lint`.

- [\#7428](https://gitlab.haskell.org//ghc/ghc/issues/7428): GHC compile times are seriously non-linear in program size

  - Here a CPS'd State monad is leading to a quadratic blowup in Core size over successive simplifier iterations

- [\#5642](https://gitlab.haskell.org//ghc/ghc/issues/5642): Deriving Generic of a big type takes a long time and lots of space


One possible solution (proposed in [\#8095](https://gitlab.haskell.org//ghc/ghc/issues/8095)) is to eliminate coercions from the Core AST during usual compilation, instead only including them when we want to lint the Core.

### Deriving instances


Another theme often seen is issues characterized by perceived slowness during compilation of code deriving instances. This could be due to a number of reasons,

1. the implementation of the logic responsible for producing the instance code is inefficient
1. the instance itself is large but could be expressed more concisely
1. the instance itself is large but irreducibly so


While it's possible to fix (1) and (2), (3) is inherent.

<table><tr><th>Ticket (Ticket query: keywords: deriving-perf, status: new, status: fixed, max: 0, col: id, col: type, col: summary, col: priority, col: owner, order: id)</th>
<th>Type (Ticket query: keywords: deriving-perf, status: new, status: fixed, max: 0, col: id, col: type, col: summary, col: priority, col: owner, order: type)</th>
<th>Summary (Ticket query: keywords: deriving-perf, status: new, status: fixed, max: 0, col: id, col: type, col: summary, col: priority, col: owner, order: summary)</th>
<th>Priority (Ticket query: keywords: deriving-perf, status: new, status: fixed, max: 0, col: id, col: type, col: summary, col: priority, col: owner, desc: 1, order: priority)</th>
<th>Owner (Ticket query: keywords: deriving-perf, status: new, status: fixed, max: 0, col: id, col: type, col: summary, col: priority, col: owner, order: owner)</th></tr>
<tr><th>[\#1544](https://gitlab.haskell.org//ghc/ghc/issues/1544)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[Derived Read instances for recursive datatypes with infix constructors are too inefficient](https://gitlab.haskell.org//ghc/ghc/issues/1544)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th></th></tr>
<tr><th>[\#7258](https://gitlab.haskell.org//ghc/ghc/issues/7258)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[Compiling DynFlags is jolly slow](https://gitlab.haskell.org//ghc/ghc/issues/7258)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th>simonpj</th></tr>
<tr><th>[\#8731](https://gitlab.haskell.org//ghc/ghc/issues/8731)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[long compilation time for module with large data type and partial record selectors](https://gitlab.haskell.org//ghc/ghc/issues/8731)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th></th></tr>
<tr><th>[\#9557](https://gitlab.haskell.org//ghc/ghc/issues/9557)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[Deriving instances is slow](https://gitlab.haskell.org//ghc/ghc/issues/9557)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th></th></tr>
<tr><th>[\#9669](https://gitlab.haskell.org//ghc/ghc/issues/9669)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[Long compile time/high memory usage for modules with many deriving clauses](https://gitlab.haskell.org//ghc/ghc/issues/9669)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th></th></tr>
<tr><th>[\#10980](https://gitlab.haskell.org//ghc/ghc/issues/10980)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      bug
                    </th>
<th>[Deriving Read instance from datatype with N fields leads to N\^2 code size growth](https://gitlab.haskell.org//ghc/ghc/issues/10980)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th></th></tr>
<tr><th>[\#13280](https://gitlab.haskell.org//ghc/ghc/issues/13280)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      task
                    </th>
<th>[Consider deriving more Foldable methods](https://gitlab.haskell.org//ghc/ghc/issues/13280)</th>
<th>
                      
                      
                      
                      
                      
                      
                      
                      
                      normal
                    </th>
<th>dfeuer</th></tr></table>

### Uncategorised compiler performance issues

- [\#2346](https://gitlab.haskell.org//ghc/ghc/issues/2346): desugaring let-bindings
- [\#10228](https://gitlab.haskell.org//ghc/ghc/issues/10228): increase in compiler memory usage, regression from 7.8.4 to 7.10.1
- [\#10289](https://gitlab.haskell.org//ghc/ghc/issues/10289): 2.5k static HashSet takes too much memory to compile

  - Significantly improved in memory usage from [\#10370](https://gitlab.haskell.org//ghc/ghc/issues/10370), but worse at overall wall-clock time!
- [\#7450](https://gitlab.haskell.org//ghc/ghc/issues/7450): Regression in optimisation time of functions with many patterns (6.12 to 7.4)? 

  - [ Phab:D1041](https://phabricator.haskell.org/D1041), [ Phab:D1012](https://phabricator.haskell.org/D1012)
  - Unnecessary recomputation of free variables ([ Phab:D1012](https://phabricator.haskell.org/D1012))
  - Thunk leak in `Bitmap` ([ Phab:D1040](https://phabricator.haskell.org/D1040))
- [\#10800](https://gitlab.haskell.org//ghc/ghc/issues/10800): vector-0.11 compile time increased substantially with 7.10.1

  - Regression in `vector` testsuite perhaps due to change in inlinings

## tests/perf/compiler\` results

### 7.6 vs 7.8

- A bit difficult to decipher, since a lot of the stats/surrounding numbers were totally rewritten due to some Testsuite API overhauls.
- The results are a mix; there are things like `peak_megabytes_allocated` being bumped up a lot, but a lot of them also had `bytes_allocated` go down as well. This one seems pretty mixed.

### 7.8 vs 7.10

- Things mostly got **better** according to these, not worse!
- Many of them had drops in `bytes_allocated`, for example, `T4801`.
- The average improvement range is something like 1-3%.
- But one got much worse; `T5837`'s `bytes_allocated` jumped from 45520936 to 115905208, 2.5x worse!

### 7.10 vs HEAD

- Most results actually got **better**, not worse!
- Silent superclasses made HEAD drop in several places, some noticeably over 2x

  - `max_bytes_used` increased in some cases, but not much, probably GC wibbles.
- No major regressions, mostly wibbles.

## Compile/build times


(NB: Sporadically updated)

**As of April 22nd**:

- GHC HEAD: 14m9s  (via 7.8.3) (because of Joachim's call-arity improvements)
- GHC 7.10: 15m43s (via 7.8.3)
- GHC 7.8:  12m54s (via 7.8.3)
- GHC 7.6:  8m19s  (via 7.4.1)


Random note: GHC 7.10's build system actually disabled DPH (half a dozen more packages and probably a hundred extra modules), yet things \*still\* got slower over time!
